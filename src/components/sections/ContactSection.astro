---
import SectionHeading from "../common/SectionHeading.astro";
import { company } from "../../data/company";

const base = import.meta.env.BASE_URL;

---

<section id="contact" class="bg-navy bg-dot-pattern-dark py-20 sm:py-28">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="animate-fade-up" data-animate>
      <SectionHeading titleEn="CONTACT" titleJa="お問い合わせ" light={true} />
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-12 lg:gap-16 animate-fade-up" data-animate>
      <!-- Left: Form (3 columns) -->
      <div class="lg:col-span-3">
        <form
          id="contact-form"
          action="https://formsubmit.co/info@sai-mon.co.jp"
          method="POST"
          class="space-y-6"
        >
          <!-- Formsubmit.co settings -->
          <input type="hidden" name="_subject" value="SAIMONウェブサイトからのお問い合わせ" />
          <input type="hidden" name="_captcha" value="false" />
          <input type="hidden" name="_template" value="table" />
          <input type="text" name="_honey" style="display:none" />

          <!-- 会社名 -->
          <div>
            <label for="company-name" class="block text-sm font-bold text-white/80 mb-2">
              会社名
              <span class="text-white/40 font-normal ml-1">（任意）</span>
            </label>
            <input
              type="text"
              id="company-name"
              name="company_name"
              class="w-full px-4 py-3 bg-white text-text-primary rounded-[var(--radius-button)] border-none focus:ring-2 focus:ring-teal focus:outline-none"
              placeholder="株式会社○○"
            />
          </div>

          <!-- お名前 -->
          <div>
            <label for="name" class="block text-sm font-bold text-white/80 mb-2">
              お名前 <span class="text-teal">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-white text-text-primary rounded-[var(--radius-button)] border-none focus:ring-2 focus:ring-teal focus:outline-none"
              placeholder="山田 太郎"
            />
          </div>

          <!-- メールアドレス -->
          <div>
            <label for="email" class="block text-sm font-bold text-white/80 mb-2">
              メールアドレス <span class="text-teal">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 bg-white text-text-primary rounded-[var(--radius-button)] border-none focus:ring-2 focus:ring-teal focus:outline-none"
              placeholder="example@company.co.jp"
            />
          </div>

          <!-- お問い合わせ内容 -->
          <div>
            <label for="message" class="block text-sm font-bold text-white/80 mb-2">
              お問い合わせ内容 <span class="text-teal">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              rows="5"
              required
              class="w-full px-4 py-3 bg-white text-text-primary rounded-[var(--radius-button)] border-none focus:ring-2 focus:ring-teal focus:outline-none resize-vertical"
              placeholder="お問い合わせ内容をご記入ください"
            ></textarea>
          </div>

          <!-- プライバシーポリシー同意 -->
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              id="privacy-agree"
              name="privacy_agree"
              required
              class="mt-1 w-4 h-4 rounded border-white/30 text-teal focus:ring-teal focus:ring-offset-0 bg-white/10"
            />
            <label for="privacy-agree" class="text-sm text-white/70 leading-relaxed">
              <a
                href={`${base}privacy-policy/`}
                target="_blank"
                rel="noopener noreferrer"
                class="text-teal underline underline-offset-4 hover:text-teal-light transition-colors duration-200"
              >
                プライバシーポリシー
              </a>
              に同意の上、送信してください。
            </label>
          </div>

          <!-- 送信ボタン -->
          <button
            type="submit"
            class="w-full bg-teal text-white py-4 font-bold rounded-[var(--radius-button)] hover:bg-teal-light transition-colors duration-300 mt-6 cursor-pointer"
          >
            送信する
          </button>

        </form>
      </div>

      <!-- Right: Contact Info (2 columns) -->
      <div class="lg:col-span-2">
        <h3 class="text-white font-bold text-lg mb-6">直接のご連絡</h3>

        <div class="text-white/70 text-sm space-y-4">
          <div>
            <p class="text-white/40 text-xs uppercase tracking-wider mb-1">Address</p>
            <p>{company.postalCode}</p>
            <p>{company.address}</p>
          </div>

          <div>
            <p class="text-white/40 text-xs uppercase tracking-wider mb-1">Email</p>
            <a
              href={`mailto:${company.email}`}
              class="hover:text-teal transition-colors duration-200"
            >
              {company.email}
            </a>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-white/10">
          <p class="text-white/50 text-sm leading-relaxed">
            通常1-2営業日以内にご返信いたします。
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Result Modal -->
<div id="form-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300">
  <div class="absolute inset-0 bg-black/60" id="form-modal-backdrop"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 sm:p-10 text-center transform scale-95 transition-transform duration-300" id="form-modal-content">
    <!-- Icon -->
    <div id="form-modal-icon" class="w-16 h-16 rounded-full mx-auto mb-5 flex items-center justify-center"></div>
    <!-- Title -->
    <h3 id="form-modal-title" class="text-xl font-black text-text-primary mb-3"></h3>
    <!-- Message -->
    <p id="form-modal-message" class="text-sm text-text-secondary leading-relaxed mb-8"></p>
    <!-- Close button -->
    <button id="form-modal-close" class="bg-navy text-white font-bold text-sm px-8 py-3 rounded-[var(--radius-button)] hover:bg-navy/90 transition-colors duration-200 cursor-pointer">
      閉じる
    </button>
  </div>
</div>

<script>
  const contactForm = document.getElementById("contact-form") as HTMLFormElement | null;
  const modal = document.getElementById("form-modal");
  const modalBackdrop = document.getElementById("form-modal-backdrop");
  const modalContent = document.getElementById("form-modal-content");
  const modalIcon = document.getElementById("form-modal-icon");
  const modalTitle = document.getElementById("form-modal-title");
  const modalMessage = document.getElementById("form-modal-message");
  const modalClose = document.getElementById("form-modal-close");

  function showModal(success: boolean) {
    if (!modal || !modalContent || !modalIcon || !modalTitle || !modalMessage) return;

    if (success) {
      modalIcon.className = "w-16 h-16 rounded-full mx-auto mb-5 flex items-center justify-center bg-teal/10";
      modalIcon.innerHTML = '<svg class="w-8 h-8 text-teal" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>';
      modalTitle.textContent = "送信完了";
      modalMessage.textContent = "お問い合わせありがとうございます。担当者より折り返しご連絡いたします。";
    } else {
      modalIcon.className = "w-16 h-16 rounded-full mx-auto mb-5 flex items-center justify-center bg-red-50";
      modalIcon.innerHTML = '<svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
      modalTitle.textContent = "送信失敗";
      modalMessage.textContent = "送信に失敗しました。お手数ですが、もう一度お試しください。";
    }

    modal.classList.remove("opacity-0", "pointer-events-none");
    modalContent.classList.remove("scale-95");
    modalContent.classList.add("scale-100");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    if (!modal || !modalContent) return;
    modal.classList.add("opacity-0", "pointer-events-none");
    modalContent.classList.remove("scale-100");
    modalContent.classList.add("scale-95");
    document.body.style.overflow = "";
  }

  modalClose?.addEventListener("click", closeModal);
  modalBackdrop?.addEventListener("click", closeModal);

  if (contactForm) {
    contactForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = contactForm.querySelector<HTMLButtonElement>('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "送信中...";
      }

      try {
        const formData = new FormData(contactForm);
        const response = await fetch(contactForm.action, {
          method: "POST",
          body: formData,
          headers: { Accept: "application/json" },
        });

        if (response.ok) {
          showModal(true);
          contactForm.reset();
        } else {
          showModal(false);
        }
      } catch {
        showModal(false);
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "送信する";
        }
      }
    });
  }

  // Scroll animation
  const contactElements = document.querySelectorAll<HTMLElement>('#contact [data-animate]');
  if (contactElements.length > 0) {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('animate-visible');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1 }
    );
    contactElements.forEach((el) => observer.observe(el));
  }
</script>
