---
import SectionHeading from "../common/SectionHeading.astro";
import { services } from "../../data/services";
---

<section id="solution" class="bg-surface-dim py-32 sm:py-40">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <SectionHeading titleEn="SOLUTION" titleJa="ソリューション" />

    <!-- Bento Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 lg:grid-rows-2 gap-6 mt-8">
      {services.map((service, index) => (
        <div
          class:list={[
            "animate-fade-up",
            index === 0 ? "lg:row-span-2" : "",
          ]}
          style={`transition-delay: ${0.1 * index}s`}
        >
          <!-- Card -->
          <button
            type="button"
            class="relative w-full text-left bg-surface border border-border rounded-[var(--radius-card)] p-8 sm:p-10 hover:shadow-card-hover hover:border-teal/30 transition-all duration-300 overflow-hidden cursor-pointer group h-full flex flex-col"
            data-service-toggle={service.id}
            aria-expanded="false"
            aria-controls={`detail-${service.id}`}
          >
            <!-- Number (absolute top-right) -->
            <span
              class="absolute top-4 right-6 font-heading text-6xl font-black text-navy/10 select-none pointer-events-none leading-none"
              aria-hidden="true"
            >
              {service.number}
            </span>

            <div class="relative z-10 flex flex-col flex-1">
              <!-- English name -->
              <span class="font-heading text-xs tracking-wider text-teal uppercase font-bold">
                {service.nameEn}
              </span>

              <!-- Japanese name -->
              <h3 class="text-xl sm:text-2xl font-black text-text-primary mt-2">
                {service.nameJa}
              </h3>

              <!-- Tagline -->
              <p class="text-text-secondary text-sm mt-3 leading-relaxed">
                {service.tagline}
              </p>

              <!-- CTA -->
              <span class="mt-6 text-navy font-bold text-sm inline-flex items-center gap-1 group-hover:gap-2 transition-all duration-200">
                詳しく見る
                <svg class="w-4 h-4 transition-transform duration-200 group-hover:translate-x-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
              </span>
            </div>
          </button>

          <!-- Accordion Detail (initially hidden) -->
          <div
            id={`detail-${service.id}`}
            class="hidden"
            data-service-detail={service.id}
          >
            <div class="bg-surface border border-border rounded-[var(--radius-card)] p-8 mt-4">
              <!-- Close button -->
              <div class="flex justify-end mb-4">
                <button
                  type="button"
                  class="text-text-secondary hover:text-text-primary transition-colors duration-200 cursor-pointer"
                  data-service-close={service.id}
                  aria-label="閉じる"
                >
                  <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <!-- Description -->
              <p class="text-text-secondary text-sm leading-relaxed mb-8">
                {service.description}
              </p>

              {/* Pillars (recruitment only) */}
              {service.pillars && service.pillars.length > 0 && (
                <div class="mb-10">
                  <h4 class="font-heading text-xs tracking-wider text-teal uppercase font-bold mb-4">
                    PILLARS
                  </h4>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {service.pillars.map((pillar) => (
                      <div class="bg-surface-dim rounded-[var(--radius-card)] p-5 border border-border">
                        <h5 class="text-sm font-bold text-text-primary mb-1">{pillar.title}</h5>
                        <p class="text-xs text-text-secondary leading-relaxed">{pillar.description}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <!-- Features -->
              <div class="mb-10">
                <h4 class="font-heading text-xs tracking-wider text-teal uppercase font-bold mb-4">
                  FEATURES
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-3">
                  {service.features.map((feature, fIdx) => (
                    <div class="flex items-start gap-3">
                      <span class="font-heading text-xs font-bold text-navy/30 mt-0.5 shrink-0 w-6">
                        {String(fIdx + 1).padStart(2, "0")}
                      </span>
                      <span class="text-sm text-text-primary leading-relaxed">{feature}</span>
                    </div>
                  ))}
                </div>
              </div>

              <!-- Steps -->
              <div class="mb-10">
                <h4 class="font-heading text-xs tracking-wider text-teal uppercase font-bold mb-6">
                  PROCESS
                </h4>
                <div class="flex flex-wrap items-start gap-4">
                  {service.steps.map((step, sIdx) => (
                    <div class="flex items-start gap-3">
                      <div class="flex flex-col items-center text-center min-w-[120px] max-w-[160px]">
                        <div class="w-10 h-10 rounded-full bg-navy/5 flex items-center justify-center mb-2">
                          <span class="font-heading text-xs font-black text-navy">
                            {String(step.number).padStart(2, "0")}
                          </span>
                        </div>
                        <span class="text-xs font-bold text-text-primary leading-snug">{step.title}</span>
                        <span class="text-[11px] text-text-secondary mt-1 leading-snug">{step.description}</span>
                      </div>
                      {sIdx < service.steps.length - 1 && (
                        <div class="flex items-center pt-3 text-navy/20" aria-hidden="true">
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                          </svg>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Pricing (recruitment only) */}
              {service.pricing && service.pricing.length > 0 && (
                <div class="mb-10">
                  <h4 class="font-heading text-xs tracking-wider text-teal uppercase font-bold mb-6">
                    PRICING
                  </h4>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {service.pricing.map((plan) => (
                      <div
                        class:list={[
                          "rounded-[var(--radius-card)] p-6 border text-center",
                          plan.highlighted
                            ? "border-teal bg-teal/5 shadow-card-hover"
                            : "border-border bg-surface-dim",
                        ]}
                      >
                        {plan.highlighted && (
                          <span class="inline-block text-[10px] font-heading font-bold uppercase tracking-wider text-teal bg-teal/10 px-3 py-1 rounded-full mb-3">
                            Recommended
                          </span>
                        )}
                        <h5 class="font-heading text-lg font-black text-text-primary">{plan.name}</h5>
                        <div class="mt-3">
                          <p class="text-xs text-text-secondary">初期費用</p>
                          <p class="text-xl font-bold text-navy">{plan.initial}</p>
                        </div>
                        <div class="mt-2">
                          <p class="text-xs text-text-secondary">月額</p>
                          <p class="text-2xl font-black text-navy">{plan.monthly}</p>
                        </div>
                        <ul class="mt-4 space-y-2 text-left">
                          {plan.features.map((f) => (
                            <li class="flex items-center gap-2 text-sm text-text-secondary">
                              <svg class="w-4 h-4 text-teal shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                              </svg>
                              {f}
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                  {service.pricingNote && (
                    <p class="text-xs text-text-secondary mt-4 text-center">{service.pricingNote}</p>
                  )}
                </div>
              )}

              <!-- FAQ -->
              {service.faq.length > 0 && (
                <div>
                  <h4 class="font-heading text-xs tracking-wider text-teal uppercase font-bold mb-4">
                    FAQ
                  </h4>
                  <div class="divide-y divide-border">
                    {service.faq.map((item) => (
                      <details class="group py-4">
                        <summary class="flex items-center justify-between cursor-pointer list-none text-sm font-bold text-text-primary hover:text-navy transition-colors duration-200">
                          <span>{item.question}</span>
                          <svg class="w-4 h-4 text-text-secondary shrink-0 ml-4 transition-transform duration-200 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                          </svg>
                        </summary>
                        <p class="mt-3 text-sm text-text-secondary leading-relaxed pl-0">
                          {item.answer}
                        </p>
                      </details>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggleButtons = document.querySelectorAll<HTMLButtonElement>("[data-service-toggle]");
    const details = document.querySelectorAll<HTMLElement>("[data-service-detail]");
    const closeButtons = document.querySelectorAll<HTMLButtonElement>("[data-service-close]");

    function closeAll() {
      details.forEach((d) => d.classList.add("hidden"));
      toggleButtons.forEach((b) => b.setAttribute("aria-expanded", "false"));
    }

    toggleButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const serviceId = btn.getAttribute("data-service-toggle");
        const target = document.querySelector<HTMLElement>(
          `[data-service-detail="${serviceId}"]`
        );
        if (!target) return;

        const isOpen = !target.classList.contains("hidden");

        // Close all first (exclusive control)
        closeAll();

        // If it was closed, open it
        if (!isOpen) {
          target.classList.remove("hidden");
          btn.setAttribute("aria-expanded", "true");
          // Scroll into view smoothly
          target.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      });
    });

    closeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        closeAll();
      });
    });
  });
</script>
